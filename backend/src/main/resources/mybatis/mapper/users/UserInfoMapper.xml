<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.koo.bonscore.biz.users.mapper.UserInfoMapper">
    <!-- 유저 정보 조회 -->
    <select id="getUserInfo" resultType="com.koo.bonscore.biz.users.dto.res.UserInfoDto" parameterType="String">
        SELECT USER_ID                               /* 사용자 ID */
             , USER_NAME                             /* 사용자 이름 */
             , EMAIL                                 /* 사용자 이메일 */
             , PHONE_NUMBER                          /* 사용자 전화번호 */
             , BIRTH_DATE                            /* 사용자 생년월일 */
             , GENDER_CODE                           /* 성별 코드 */
          FROM USER_INFO                             /* 유저정보 테이블 */
         WHERE USER_ID = #{userId}                   /* 사용자 ID */
      ORDER BY USER_ID DESC
    </select>

    <!-- 유저 권한 조회 -->
    <select id="getUserRole" resultType="com.koo.bonscore.biz.users.dto.res.UserInfoDto" parameterType="String">
        SELECT ROLE_ID                               /* 권한 ID */
          FROM ROLE_USER                             /* 사용자/권한 매핑 */
         WHERE USER_ID = #{userId}                   /* 사용자 ID */
    </select>

    <!-- 휴면전환 30일전 안내메일 발송대상 조회 -->
    <select id="getUsersForDormancyNotice" resultType="com.koo.bonscore.biz.users.dto.DormantUserInfoDto">
        <![CDATA[
        SELECT /* com.koo.bonscore.biz.users.mapper.UserInfoMapper.getUsersForDormancyNotice */
               USER_ID                               /* 사용자 ID */
             , USER_NAME                             /* 사용자 이름 */
             , EMAIL                                 /* 사용자 이메일 */
          FROM USER_INFO                             /* 유저정보 테이블 */
         WHERE ACCOUNT_LOCKED = 'N'
           AND WITHDRAWN      = 'N'
           AND TRUNC(LAST_LOGIN_AT) = TRUNC(ADD_MONTHS(SYSTIMESTAMP, -12) + 30)
        ]]>
    </select>

    <!-- 휴먼대상 계정 조회 -->
    <select id="getDormantUsers" resultType="com.koo.bonscore.biz.users.dto.DormantUserInfoDto">
        <![CDATA[
            SELECT /* com.koo.bonscore.biz.users.mapper.UserInfoMapper.getDormantUsers */
                   USER_ID                               /* 사용자 ID */
                 , USER_NAME                             /* 사용자 이름 */
                 , EMAIL                                 /* 사용자 이메일 */
                 , EMAIL_HASH                            /* 사용자 이메일 해쉬 */
                 , PHONE_NUMBER                          /* 사용자 전화번호 */
                 , BIRTH_DATE                            /* 사용자 생년월일 */
                 , GENDER_CODE                           /* 성별 코드 */
                 , PASSWORD_HINT                         /* 비밀번호 힌트 */
                 , PASSWORD_HINT_ANSWER                  /* 비밀번호 힌트 정답 */
                 , PASSWORD_UPDATED                      /* 비밀번호 변경일자 */
                 , TERMS_AGREE_1                         /* 약관 동의 여부1 */
                 , TERMS_AGREE_2                         /* 약관 동의 여부2 */
                 , TERMS_AGREE_3                         /* 약관 동의 여부3 */
                 , TERMS_AGREE_4                         /* 약관 동의 여부4 */
              FROM USER_INFO                             /* 유저정보 테이블 */
             WHERE ACCOUNT_LOCKED = 'N'
               AND WITHDRAWN      = 'N'
               AND LAST_LOGIN_AT  <= ADD_MONTHS(SYSTIMESTAMP, -12)
        ]]>
    </select>

    <!-- 휴먼대상 계정 분리 -->
    <insert id="insertDormantUsers" parameterType="com.koo.bonscore.biz.users.dto.DormantUserInfoDto">
        INSERT /* com.koo.bonscore.biz.users.mapper.UserInfoMapper.insertDormantUsers */
          INTO USER_DORMANT_INFO                     /* 휴먼 사용자 정보 */
             (
               USER_ID                               /* 사용자 ID */
             , USER_NAME                             /* 사용자 이름 */
             , EMAIL                                 /* 사용자 이메일 */
             , EMAIL_HASH                            /* 사용자 이메일 해쉬 */
             , PHONE_NUMBER                          /* 사용자 전화번호 */
             , BIRTH_DATE                            /* 사용자 생년월일 */
             , GENDER_CODE                           /* 성별 코드 */
             , PASSWORD_HINT                         /* 비밀번호 힌트 */
             , PASSWORD_HINT_ANSWER                  /* 비밀번호 힌트 정답 */
             , PASSWORD_UPDATED                      /* 비밀번호 변경일자 */
             , TERMS_AGREE_1                         /* 약관 동의 여부1 */
             , TERMS_AGREE_2                         /* 약관 동의 여부2 */
             , TERMS_AGREE_3                         /* 약관 동의 여부3 */
             , TERMS_AGREE_4                         /* 약관 동의 여부4 */
             , CREATED_AT                            /* 생성일시 */
             )
        <foreach collection="users" item="user" separator=" UNION ALL ">
        SELECT
               #{user.userId}
             , #{user.userName}
             , #{user.email}
             , #{user.emailHash}
             , #{user.phoneNumber}
             , #{user.birthDate}
             , #{user.genderCode}
             , #{user.passwordHint}
             , #{user.passwordHintAnswer}
             , TO_DATE(#{user.passwordUpdated}, 'YYYY-MM-DD HH24:MI:SS')
             , #{user.termsAgree1}
             , #{user.termsAgree2}
             , #{user.termsAgree3}
             , #{user.termsAgree4}
             , SYSTIMESTAMP
          FROM DUAL
        </foreach>
    </insert>

    <!-- 원본 테이블의 개인정보 파기 및 상태 업데이트 -->
    <update id="updateUsersToDormantState" parameterType="com.koo.bonscore.biz.users.dto.DormantUserInfoDto">
        UPDATE /* com.koo.bonscore.biz.users.mapper.UserInfoMapper.updateUsersToDormantState */
               USER_INFO                                /* 유저정보 테이블 */
           SET USER_NAME             = 'DORMANT_USER'   /* 사용자 이름 (휴면 사용자로 표시) */
             , EMAIL                 = NULL             /* 사용자 이메일 */
             , EMAIL_HASH            = NULL             /* 이메일 해시 */
             , PHONE_NUMBER          = NULL             /* 전화번호 */
             , BIRTH_DATE            = NULL             /* 생년월일 */
             , GENDER_CODE           = NULL             /* 성별 코드 */
             , PASSWORD_HINT         = NULL             /* 비밀번호 힌트 */
             , PASSWORD_HINT_ANSWER  = NULL             /* 비밀번호 힌트 정답 */
             , PASSWORD_UPDATED      = NULL             /* 비밀번호 변경일자 */
             , TERMS_AGREE_1         = 'N'              /* 약관 동의 여부1 */
             , TERMS_AGREE_2         = 'N'              /* 약관 동의 여부2 */
             , TERMS_AGREE_3         = 'N'              /* 약관 동의 여부3 */
             , TERMS_AGREE_4         = 'N'              /* 약관 동의 여부4 */
             , ACCOUNT_LOCKED        = 'Y'              /* 계정 잠금 상태로 변경 */
             , UPDATED_AT            = SYSTIMESTAMP     /* 수정일시 갱신 */
         WHERE USER_ID IN
        <foreach collection="userIds" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
    </update>

    <!-- 휴면 해제를 위해 분리 보관된 사용자 정보 조회 -->
    <select id="getDormantUserInfo" resultType="com.koo.bonscore.biz.users.dto.DormantUserInfoDto" parameterType="String">
        SELECT /* com.koo.bonscore.biz.users.mapper.UserInfoMapper.getDormantUserInfo */
               USER_ID                               /* 사용자 ID */
             , USER_NAME                             /* 사용자 이름 */
             , EMAIL                                 /* 사용자 이메일 */
             , EMAIL_HASH                            /* 사용자 이메일 해쉬 */
             , PHONE_NUMBER                          /* 사용자 전화번호 */
             , BIRTH_DATE                            /* 사용자 생년월일 */
             , GENDER_CODE                           /* 성별 코드 */
             , PASSWORD_HINT                         /* 비밀번호 힌트 */
             , PASSWORD_HINT_ANSWER                  /* 비밀번호 힌트 정답 */
             , PASSWORD_UPDATED                      /* 비밀번호 변경일자 */
             , TERMS_AGREE_1                         /* 약관 동의 여부1 */
             , TERMS_AGREE_2                         /* 약관 동의 여부2 */
             , TERMS_AGREE_3                         /* 약관 동의 여부3 */
             , TERMS_AGREE_4                         /* 약관 동의 여부4 */
          FROM USER_DORMANT_INFO                     /* 휴먼 사용자 정보 */
         WHERE USER_ID = #{userId}
    </select>

    <update id="restoreUserFromDormancy" parameterType="com.koo.bonscore.biz.users.dto.DormantUserInfoDto">
        UPDATE /* com.koo.bonscore.biz.users.mapper.UserInfoMapper.restoreUserFromDormancy */
               USER_INFO
           SET USER_NAME             = #{userName}
             , EMAIL                 = #{email}
             , EMAIL_HASH            = #{emailHash}
             , PHONE_NUMBER          = #{phoneNumber}
             , BIRTH_DATE            = #{birthDate}
             , GENDER_CODE           = #{genderCode}
             , PASSWORD_HINT         = #{passwordHint}
             , PASSWORD_HINT_ANSWER  = #{passwordHintAnswer}
             , PASSWORD_UPDATED      = TO_DATE(#{passwordUpdated}, 'YYYY-MM-DD HH24:MI:SS')
             , TERMS_AGREE_1         = #{termsAgree1}
             , TERMS_AGREE_2         = #{termsAgree2}
             , TERMS_AGREE_3         = #{termsAgree3}
             , TERMS_AGREE_4         = #{termsAgree4}
             , ACCOUNT_LOCKED        = 'N'
             , LAST_LOGIN_AT         = SYSTIMESTAMP
             , UPDATED_AT            = SYSTIMESTAMP
         WHERE USER_ID   = #{userId}
    </update>

    <!-- 분리 보관 테이블에서 사용자 정보 삭제 -->
    <delete id="deleteDormantUserInfo" parameterType="String">
        DELETE /* com.koo.bonscore.biz.users.mapper.UserInfoMapper.deleteDormantUserInfo */
          FROM USER_DORMANT_INFO                     /* 휴먼 사용자 정보 */
         WHERE USER_ID = #{userId}
    </delete>

</mapper>