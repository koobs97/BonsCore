<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.koo.bonscore.biz.auth.mapper.AuthMapper">

    <!-- 해싱된 패스워드 조회 -->
    <select id="login" resultType="com.koo.bonscore.biz.auth.dto.LoginCheckDto" parameterType="com.koo.bonscore.biz.auth.dto.req.LoginDto">
        SELECT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.login */
               PASSWORD_HASH                         /* 비밀번호 해시 */
             , ACCOUNT_LOCKED                        /* 휴먼 계정 여부 */
             , REQUIRES_VERIFICATION_YN              /* 계정 추가 인증 필요 여부 */
          FROM USER_INFO                             /* 유저정보 테이블 */
         WHERE USER_ID          = #{userId}          /* 사용자 ID */
           AND WITHDRAWN        = 'N'                /* 탈퇴 여부 */
      ORDER BY USER_ID DESC
    </select>

    <!-- 유저 정보 조회 -->
    <select id="findByUserId" resultType="com.koo.bonscore.biz.auth.dto.UserDto" parameterType="com.koo.bonscore.biz.auth.dto.req.LoginDto">
        SELECT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.findByUserId */
               USER_ID                               /* 사용자 ID */
             , USER_NAME                             /* 사용자 이름 */
             , EMAIL                                 /* 사용자 이메일 */
             , PHONE_NUMBER                          /* 사용자 전화번호 */
             , BIRTH_DATE                            /* 사용자 생년월일 */
             , GENDER_CODE                           /* 성별 코드 */
          FROM USER_INFO                             /* 유저정보 테이블 */
         WHERE USER_ID = #{userId}                   /* 사용자 ID */
         ORDER BY USER_ID DESC
    </select>

    <!-- 유저 권한 조회 -->
    <select id="findRoleByUserId" resultType="String" parameterType="String">
        SELECT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.findRoleByUserId */
               ROLE_ID                               /* 권한 ID */
          FROM ROLE_USER                             /* 권한/사용자와 매핑 */
         WHERE USER_ID = #{userId}                   /* 사용자 ID */
    </select>

    <!-- 사용자의 최근 접속 국가 목록 조회 (중복 제거) -->
    <select id="findRecentLoginCountries" parameterType="string" resultType="string">
        <![CDATA[
          SELECT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.findRecentLoginCountries */
                 DISTINCT COUNTRY_CODE
            FROM (
                     SELECT COUNTRY_CODE
                       FROM LOGIN_HISTORY
                      WHERE USER_ID         = #{userId}
                        AND COUNTRY_CODE    IS NOT NULL
                   ORDER BY LOGIN_AT DESC
                 )
           WHERE ROWNUM <= 10
        ]]>
    </select>

    <!-- 비정상 로그인 시도로 계정잠김 -->
    <update id="updateRequiresYn" parameterType="com.koo.bonscore.biz.auth.dto.req.LoginDto">
        UPDATE /* com.koo.bonscore.biz.auth.mapper.AuthMapper.updateRequiresYn */
               USER_INFO                             /* 유저정보 테이블 */
           SET REQUIRES_VERIFICATION_YN = 'Y'        /* 계정 추가 인증 필요 여부 */
             , UPDATED_AT       = #{updatedAt}       /* 수정일시 */
         WHERE USER_ID          = #{userId}          /* 아이디 */
    </update>

    <!-- 로그인일시 업데이트 -->
    <update id="updateLoginAt" parameterType="com.koo.bonscore.biz.auth.dto.req.LoginDto">
        UPDATE /* com.koo.bonscore.biz.auth.mapper.AuthMapper.updateLoginAt */
               USER_INFO                             /* 유저정보 테이블 */
           SET LAST_LOGIN_AT = SYSTIMESTAMP          /* 마지막로그인일시 */
         WHERE USER_ID       = #{userId}             /* 사용자 ID */
    </update>

    <!-- 로그인 기록 저장 -->
    <insert id="insertLoginHistory" parameterType="com.koo.bonscore.biz.auth.dto.LoginHistoryDto">
        INSERT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.insertLoginHistory */
          INTO LOGIN_HISTORY
             (
               HISTORY_SEQ
             , USER_ID
             , LOGIN_AT
             , IP_ADDRESS
             , USER_AGENT
             , COUNTRY_CODE
             , CITY_NAME
             , LOGIN_SUCCESS_YN
             )
        VALUES
             (
               SEQ_LOGIN_HISTORY.NEXTVAL
             , #{userId}
             , SYSTIMESTAMP
             , #{ipAddress}
             , #{userAgent}
             , #{countryCode}
             , #{cityName}
             , 'Y'
             )
    </insert>

    <!-- 아이디 중복 체크 -->
    <select id="existsById" resultType="Integer" parameterType="com.koo.bonscore.biz.auth.dto.req.SignUpDto">
        SELECT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.existsById */
               COUNT(1)   AS USER_ID_CNT             /* 사용중인 ID 개수 */
          FROM USER_INFO                             /* 유저정보 테이블 */
         WHERE USER_ID = #{userId}                   /* 사용자 ID */
    </select>

    <!-- email 중복 체크 -> email은 UNIQUE key 임 -->
    <select id="existsByEmail" resultType="Integer" parameterType="com.koo.bonscore.biz.auth.dto.req.SignUpDto">
       SELECT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.existsByEmail */
              COUNT(1)   AS EMAIL_ID_CNT            /* 사용중인 email 개수 */
         FROM USER_INFO                             /* 유저정보 테이블 */
        WHERE EMAIL_HASH = #{emailHash}             /* email */
    </select>

    <!-- 회원가입 -->
    <insert id="signUpUser" parameterType="com.koo.bonscore.biz.auth.dto.req.SignUpDto">
       INSERT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.signUpUser */
         INTO USER_INFO                             /* 유저정보 테이블 */
            (
              USER_ID                               /* 사용자 ID */
            , USER_NAME                             /* 사용자 이름 */
            , EMAIL                                 /* 사용자 이메일 */
            , EMAIL_HASH                            /* 사용자 이메일 해쉬 */
            , PHONE_NUMBER                          /* 사용자 전화번호 */
            , BIRTH_DATE                            /* 사용자 생년월일 */
            , GENDER_CODE                           /* 성별 코드 */
            , PASSWORD_HASH                         /* 비밀번호 해쉬 */
            , PASSWORD_HINT                         /* 비밀번호 힌트 */
            , PASSWORD_HINT_ANSWER                  /* 비밀번호 힌트 정답 */
            , PASSWORD_UPDATED                      /* 비밀번호 변경일자 */
            , ACCOUNT_LOCKED                        /* 휴먼계정여부 */
            , WITHDRAWN                             /* 탈퇴여부 */
            , LAST_LOGIN_AT                         /* 마지막 로그인 일시 */
            , TERMS_AGREE_1                         /* 약관 동의 여부1 */
            , TERMS_AGREE_2                         /* 약관 동의 여부2 */
            , TERMS_AGREE_3                         /* 약관 동의 여부3 */
            , TERMS_AGREE_4                         /* 약관 동의 여부4 */
            , CREATED_AT                            /* 생성일시 */
            , UPDATED_AT                            /* 수정일시 */
            )
       VALUES
            (
              #{userId}
            , #{userName}
            , #{email}
            , #{emailHash}
            , #{phoneNumber}
            , #{birthDate}
            , #{genderCode}
            , #{password}
            , NULL
            , NULL
            , #{passwordUpdated}
            , 'N'
            , 'N'
            , NULL
            , #{termsAgree1}
            , #{termsAgree2}
            , #{termsAgree3}
            , #{termsAgree4}
            , #{createdAt}
            , #{updatedAt}
            )
    </insert>

    <!-- 회원가입 시 일반사용자 권한부여 -->
    <insert id="signUpUserRole" parameterType="com.koo.bonscore.biz.auth.dto.req.SignUpDto">
       INSERT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.signUpUserRole */
         INTO ROLE_USER                             /* 권한/사용자 매핑 */
            (
              USER_ID                               /* 사용자 ID */
            , ROLE_ID                               /* 권한 ID */
            )
       VALUES
            (
              #{userId}                             /* 사용자 ID */
            , 'USER'                                /* 권한 ID */
            )
    </insert>

    <!-- 사용자 이름과 이메일이 일치하는 사용자를 조회 -->
    <select id="findByUserNameAndEmail" resultType="String" parameterType="com.koo.bonscore.biz.auth.dto.req.UserInfoSearchDto">
       SELECT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.findByUserNameAndEmail */
              USER_NAME                             /* 사용자 이름 */
         FROM USER_INFO                             /* 유저정보 테이블 */
        WHERE EMAIL_HASH = #{email}                 /* email */
    </select>

    <!-- 사용자 ID 조회 -->
    <select id="findUserIdByMail" resultType="String" parameterType="com.koo.bonscore.biz.auth.dto.req.UserInfoSearchDto">
       SELECT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.findUserIdByMail */
              USER_ID                               /* 사용자 ID */
         FROM USER_INFO                             /* 유저정보 테이블 */
        WHERE EMAIL_HASH = #{email}                 /* email */
    </select>

    <!-- 사용자 아이디로 유저명, 이메일 조회 -->
    <select id="findUserById" resultType="com.koo.bonscore.biz.auth.dto.req.UserInfoSearchDto" parameterType="com.koo.bonscore.biz.auth.dto.req.UserInfoSearchDto">
        SELECT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.findUserById */
               USER_NAME                             /* 사용자 이름 */
             , EMAIL                                 /* 이메일 */
          FROM USER_INFO                             /* 유저정보 테이블 */
         WHERE USER_ID = #{nonMaskedId}
    </select>

    <!-- 사용자가 입력한 유저명, 이메일이 맞는지 조회 -->
    <select id="findUserByNameMail" resultType="com.koo.bonscore.biz.auth.dto.req.UserInfoSearchDto" parameterType="com.koo.bonscore.biz.auth.dto.req.UserInfoSearchDto">
        SELECT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.findUserByNameMail */
               USER_ID                               /* 사용자 ID */
             , USER_NAME                             /* 사용자명 */
             , EMAIL                                 /* 이메일 */
          FROM USER_INFO                             /* 유저정보 테이블 */
         WHERE EMAIL_HASH = #{email}
    </select>

    <!-- 사용자 아이디로 보안질문 조회 -->
    <select id="findPasswordHintById" resultType="String" parameterType="com.koo.bonscore.biz.auth.dto.req.UserInfoSearchDto">
        SELECT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.findPasswordHintById */
               B.QUESTION_TEXT                       /* 질문 내용 */
          FROM USER_INFO            A                /* 유저정보 테이블 */
             , SECURITY_QUESTION    B                /* 보안 질문 마스터 테이블 */
         WHERE A.USER_ID       = #{userId}
           AND A.PASSWORD_HINT = B.QUESTION_CODE
    </select>

    <!-- 보안질문 정답 조회 -->
    <select id="findHintAnswerById" resultType="String" parameterType="com.koo.bonscore.biz.auth.dto.req.UserInfoSearchDto">
        SELECT /* com.koo.bonscore.biz.auth.mapper.AuthMapper.findHintAnswerById */
               PASSWORD_HINT_ANSWER                  /* 비밀번호 힌트 정답 */
          FROM USER_INFO                             /* 유저정보 테이블 */
         WHERE USER_ID  = #{userId}
    </select>

    <!-- 비밀번호 변경 -->
    <update id="updatePassword" parameterType="com.koo.bonscore.biz.auth.dto.req.UserInfoSearchDto">
        UPDATE /* com.koo.bonscore.biz.auth.mapper.AuthMapper.updatePassword */
               USER_INFO                             /* 유저정보 테이블 */
           SET PASSWORD_HASH    = #{password}        /* 비밀번호 */
             , PASSWORD_UPDATED = #{passwordUpdated} /* 비밀번호 업데이트 일시 */
             , UPDATED_AT       = #{updatedAt}       /* 수정일시 */
         WHERE USER_ID          = #{userId}          /* 아이디 */
    </update>

    <!-- 계정잠김 해제 -->
    <update id="updateUnLocked" parameterType="com.koo.bonscore.biz.auth.dto.req.UserInfoSearchDto">
        UPDATE /* com.koo.bonscore.biz.auth.mapper.AuthMapper.updateUnLocked */
               USER_INFO                             /* 유저정보 테이블 */
           SET REQUIRES_VERIFICATION_YN = 'N'        /* 계정 추가 인증 필요 여부 */
             , ACCOUNT_LOCKED           = 'N'        /* 휴먼계정여부 */
             , UPDATED_AT       = #{updatedAt}       /* 수정일시 */
         WHERE USER_ID          = #{userId}          /* 아이디 */
    </update>

</mapper>